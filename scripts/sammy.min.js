(function(f,g){var d,p=/:([\w\d]+)/g,s=/\?([^#]*)?$/,k=function(a){return Array.prototype.slice.call(a)},h=function(a){return"[object Function]"===Object.prototype.toString.call(a)},l=function(a){return"[object Array]"===Object.prototype.toString.call(a)},o=function(a){return decodeURIComponent((a||"").replace(/\+/g," "))},t=encodeURIComponent,u=function(a){return(""+a).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},m=function(a){return function(b,
c){return this.route.apply(this,[a,b,c])}},q={},n=!(!g.history||!history.pushState),v=[];d=function(){var a=k(arguments),b,c;d.apps=d.apps||{};if(0===a.length||a[0]&&h(a[0]))return d.apply(d,["body"].concat(a));if("string"==typeof(c=a.shift()))return b=d.apps[c]||new d.Application,b.element_selector=c,0<a.length&&f.each(a,function(a,c){b.use(c)}),b.element_selector!=c&&delete d.apps[c],d.apps[b.element_selector]=b};d.VERSION="0.7.1";d.addLogger=function(a){v.push(a)};d.log=function(){var a=k(arguments);
a.unshift("["+Date()+"]");f.each(v,function(b,c){c.apply(d,a)})};"undefined"!=typeof g.console?h(g.console.log.apply)?d.addLogger(function(){g.console.log.apply(g.console,arguments)}):d.addLogger(function(){g.console.log(arguments)}):"undefined"!=typeof console&&d.addLogger(function(){console.log.apply(console,arguments)});f.extend(d,{makeArray:k,isFunction:h,isArray:l});d.Object=function(a){return f.extend(this,a||{})};f.extend(d.Object.prototype,{escapeHTML:u,h:u,toHash:function(){var a={};f.each(this,
function(b,c){h(c)||(a[b]=c)});return a},toHTML:function(){var a="";f.each(this,function(b,c){h(c)||(a+="<strong>"+b+"</strong> "+c+"<br />")});return a},keys:function(a){var b=[],c;for(c in this)(!h(this[c])||!a)&&b.push(c);return b},has:function(a){return this[a]&&""!==f.trim(this[a].toString())},join:function(){var a=k(arguments),b=a.shift();return a.join(b)},log:function(){d.log.apply(d,arguments)},toString:function(a){var b=[];f.each(this,function(c,e){(!h(e)||a)&&b.push('"'+c+'": '+e.toString())});
return"Sammy.Object: {"+b.join(",")+"}"}});d.DefaultLocationProxy=function(a,b){this.app=a;this.is_native=!1;this.has_history=n;this._startPolling(b)};d.DefaultLocationProxy.fullPath=function(a){var b=a.toString().match(/^[^#]*(#.+)$/);return[a.pathname,a.search,b?b[1]:""].join("")};d.DefaultLocationProxy.prototype={bind:function(){var a=this,b=this.app,c=d.DefaultLocationProxy;f(g).bind("hashchange."+this.app.eventNamespace(),function(e,d){!1===a.is_native&&!d&&(a.is_native=!0,g.clearInterval(c._interval));
b.trigger("location-changed")});n&&!b.disable_push_state&&(f(g).bind("popstate."+this.app.eventNamespace(),function(){b.trigger("location-changed")}),f("a").live("click.history-"+this.app.eventNamespace(),function(e){if(!e.isDefaultPrevented()){var d=c.fullPath(this);if(this.hostname==g.location.hostname&&b.lookupRoute("get",d))return e.preventDefault(),a.setLocation(d),!1}}));c._bindings||(c._bindings=0);c._bindings++},unbind:function(){f(g).unbind("hashchange."+this.app.eventNamespace());f(g).unbind("popstate."+
this.app.eventNamespace());f("a").die("click.history-"+this.app.eventNamespace());d.DefaultLocationProxy._bindings--;0>=d.DefaultLocationProxy._bindings&&g.clearInterval(d.DefaultLocationProxy._interval)},getLocation:function(){return d.DefaultLocationProxy.fullPath(g.location)},setLocation:function(a){/^([^#\/]|$)/.test(a)&&(a=n?"/"+a:"#!/"+a);if(a!=this.getLocation())if(n&&/^\//.test(a))history.pushState({path:a},g.title,a),this.app.trigger("location-changed");else return g.location=a},_startPolling:function(a){var b=
this;if(!d.DefaultLocationProxy._interval){a||(a=10);var c=function(){var a=b.getLocation();("undefined"==typeof d.DefaultLocationProxy._last_location||a!=d.DefaultLocationProxy._last_location)&&g.setTimeout(function(){f(g).trigger("hashchange",[!0])},0);d.DefaultLocationProxy._last_location=a};c();d.DefaultLocationProxy._interval=g.setInterval(c,a)}}};d.Application=function(a){var b=this;this.routes={};this.listeners=new d.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date).getTime()+
"-"+parseInt(1E3*Math.random(),10);this.context_prototype=function(){d.EventContext.apply(this,arguments)};this.context_prototype.prototype=new d.EventContext;h(a)&&a.apply(this,[this]);this._location_proxy||this.setLocationProxy(new d.DefaultLocationProxy(this,this.run_interval_every));this.debug&&this.bindToAllEvents(function(a,e){b.log(b.toString(),a.cleaned_type,e||{})})};d.Application.prototype=f.extend({},d.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:"run,unload,lookup-route,run-route,route-found,event-context-before,event-context-after,changed,error,check-form-submission,redirect,location-changed".split(","),
_last_route:null,_location_proxy:null,_running:!1,element_selector:"body",debug:!1,raise_errors:!1,run_interval_every:50,disable_push_state:!1,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(a){return a?f(this.element_selector).find(a):f(this.element_selector)},use:function(){var a=k(arguments),b=a.shift(),c=b||"";try{a.unshift(this),"string"==typeof b&&(c="Sammy."+b,b=d[b]),b.apply(this,a)}catch(e){"undefined"===typeof b?this.error("Plugin Error: called use() but plugin ("+
c.toString()+") is not defined",e):h(b)?this.error("Plugin Error",e):this.error("Plugin Error: called use() but '"+c.toString()+"' is not a function",e)}return this},setLocationProxy:function(a){var b=this._location_proxy;this._location_proxy=a;this.isRunning()&&(b&&b.unbind(),this._location_proxy.bind())},log:function(){d.log.apply(d,Array.prototype.concat.apply([this.element_selector],arguments))},route:function(a,b,c){var e=this,d=[],j,i;!c&&h(b)&&(c=b=a,a="any");a=a.toLowerCase();if(b.constructor==
String){for(p.lastIndex=0;null!==(i=p.exec(b));)d.push(i[1]);b=RegExp(b.replace(p,"([^/]+)")+"$")}"string"==typeof c&&(c=e[c]);j=function(a){var f={verb:a,path:b,callback:c,param_names:d};e.routes[a]=e.routes[a]||[];e.routes[a].push(f)};"any"===a?f.each(this.ROUTE_VERBS,function(a,b){j(b)}):j(a);return this},get:m("get"),post:m("post"),put:m("put"),del:m("delete"),any:m("any"),mapRoutes:function(a){var b=this;f.each(a,function(a,e){b.route.apply(b,e)});return this},eventNamespace:function(){return["sammy-app",
this.namespace].join("-")},bind:function(a,b,c){var e=this;"undefined"==typeof c&&(c=b);b=function(a,b){var d;b&&b.context?(d=b.context,delete b.context):d=new e.context_prototype(e,"bind",a.type,b,a.target);a.cleaned_type=a.type.replace(e.eventNamespace(),"");c.apply(d,[a,b])};this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b);this.isRunning()&&this._listen(a,b);return this},trigger:function(a,b){this.$element().trigger([a,this.eventNamespace()].join("."),[b]);return this},refresh:function(){this.last_location=
null;this.trigger("location-changed");return this},before:function(a,b){h(a)&&(b=a,a={});this.befores.push([a,b]);return this},after:function(a){return this.bind("event-context-after",a)},around:function(a){this.arounds.push(a);return this},isRunning:function(){return this._running},helpers:function(a){f.extend(this.context_prototype.prototype,a);return this},helper:function(a,b){this.context_prototype.prototype[a]=b;return this},run:function(a){if(this.isRunning())return!1;var b=this;f.each(this.listeners.toHash(),
function(a,e){f.each(e,function(e,d){b._listen(a,d)})});this.trigger("run",{start_url:a});this._running=!0;this.last_location=null;!/\#(.+)/.test(this.getLocation())&&"undefined"!=typeof a&&this.setLocation(a);this._checkLocation();this._location_proxy.bind();this.bind("location-changed",function(){b._checkLocation()});this.bind("submit",function(a){return!1===b._checkFormSubmission(f(a.target).closest("form"))?a.preventDefault():!1});f(g).bind("unload",function(){b.unload()});return this.trigger("changed")},
unload:function(){if(!this.isRunning())return!1;var a=this;this.trigger("unload");this._location_proxy.unbind();this.$element().unbind("submit").removeClass(a.eventNamespace());f.each(this.listeners.toHash(),function(b,c){f.each(c,function(c,d){a._unlisten(b,d)})});this._running=!1;return this},bindToAllEvents:function(a){var b=this;f.each(this.APP_EVENTS,function(c,e){b.bind(e,a)});f.each(this.listeners.keys(!0),function(c,e){-1==f.inArray(e,b.APP_EVENTS)&&b.bind(e,a)});return this},routablePath:function(a){return a.replace(s,
"")},lookupRoute:function(a,b){var c=!1,e=0,d,f;if("undefined"!=typeof this.routes[a])for(d=this.routes[a].length;e<d;e++)if(f=this.routes[a][e],this.routablePath(b).match(f.path)){c=f;break}return c},runRoute:function(a,b,c,e){var d=this,j=this.lookupRoute(a,b),i,g,h,r,k,l,m;this.log("runRoute",[a,b].join(" "));this.trigger("run-route",{verb:a,path:b,params:c});"undefined"==typeof c&&(c={});f.extend(c,this._parseQueryString(b));if(j){this.trigger("route-found",{route:j});if(null!==(l=j.path.exec(this.routablePath(b))))l.shift(),
f.each(l,function(a,b){j.param_names[a]?c[j.param_names[a]]=o(b):(c.splat||(c.splat=[]),c.splat.push(o(b)))});i=new this.context_prototype(this,a,b,c,e);e=this.arounds.slice(0);h=this.befores.slice(0);k=[i].concat(c.splat);g=function(){for(var a;0<h.length;)if(r=h.shift(),d.contextMatchesOptions(i,r[0])&&(a=r[1].apply(i,[i]),!1===a))return!1;d.last_route=j;i.trigger("event-context-before",{context:i});a=j.callback.apply(i,k);i.trigger("event-context-after",{context:i});return a};f.each(e.reverse(),
function(a,b){var c=g;g=function(){return b.apply(i,[c])}});try{m=g()}catch(n){this.error(["500 Error",a,b].join(" "),n)}return m}return this.notFound(a,b)},contextMatchesOptions:function(a,b,c){if("undefined"===typeof b||f.isEmptyObject(b))return!0;"undefined"===typeof c&&(c=!0);if("string"===typeof b||h(b.test))b={path:b};if(l(b.path)){var e,d,j;e=[];for(d in b.path)j=f.extend({},b,{path:b.path[d]}),e.push(this.contextMatchesOptions(a,j));a=-1<f.inArray(!0,e)?!0:!1;return c?a:!a}if(b.only)return this.contextMatchesOptions(a,
b.only,!0);if(b.except)return this.contextMatchesOptions(a,b.except,!1);e=d=!0;b.path&&(h(b.path.test)||(b.path=RegExp(b.path.toString()+"$")),d=b.path.test(a.path));b.verb&&(e="string"===typeof b.verb?b.verb===a.verb:-1<b.verb.indexOf(a.verb));return c?e&&d:!(e&&d)},getLocation:function(){return this._location_proxy.getLocation()},setLocation:function(a){return this._location_proxy.setLocation(a)},swap:function(a,b){var c=this.$element().html(a);h(b)&&b(a);return c},templateCache:function(a,b){return"undefined"!=
typeof b?q[a]=b:q[a]},clearTemplateCache:function(){return q={}},notFound:function(a,b){var c=this.error(["404 Not Found",a,b].join(" "));return"get"===a?c:!0},error:function(a,b){b||(b=Error());b.message=[a,b.message].join(" ");this.trigger("error",{message:b.message,error:b});if(this.raise_errors)throw b;this.log(b.message,b)},_checkLocation:function(){var a,b;a=this.getLocation();if(!this.last_location||"get"!=this.last_location[0]||this.last_location[1]!=a)this.last_location=["get",a],b=this.runRoute("get",
a);return b},_getFormVerb:function(a){var a=f(a),b,c;c=a.find('input[name="_method"]');0<c.length&&(b=c.val());b||(b=a[0].getAttribute("method"));if(!b||""==b)b="get";return f.trim(b.toString().toLowerCase())},_checkFormSubmission:function(a){var b,c,e;this.trigger("check-form-submission",{form:a});b=f(a);c=b.attr("action")||"";e=this._getFormVerb(b);this.log("_checkFormSubmission",b,c,e);"get"===e?(b=this._serializeFormParams(b),""!==b&&(c+="?"+b),this.setLocation(c),a=!1):(b=f.extend({},this._parseFormParams(b)),
a=this.runRoute(e,c,b,a.get(0)));return"undefined"==typeof a?!1:a},_serializeFormParams:function(a){var b="",a=a.serializeArray(),c;if(0<a.length){b=this._encodeFormPair(a[0].name,a[0].value);for(c=1;c<a.length;c++)b=b+"&"+this._encodeFormPair(a[c].name,a[c].value)}return b},_encodeFormPair:function(a,b){return t(a)+"="+t(b)},_parseFormParams:function(a){var b={},a=a.serializeArray(),c;for(c=0;c<a.length;c++)b=this._parseParamPair(b,a[c].name,a[c].value);return b},_parseQueryString:function(a){var b=
{},c,e;if(a=a.match(s)){a=a[1].split("&");for(e=0;e<a.length;e++)c=a[e].split("="),b=this._parseParamPair(b,o(c[0]),o(c[1]||""))}return b},_parseParamPair:function(a,b,c){"undefined"!==typeof a[b]?l(a[b])?a[b].push(c):a[b]=[a[b],c]:a[b]=c;return a},_listen:function(a,b){return this.$element().bind([a,this.eventNamespace()].join("."),b)},_unlisten:function(a,b){return this.$element().unbind([a,this.eventNamespace()].join("."),b)}});d.RenderContext=function(a){this.event_context=a;this.callbacks=[];
this.content=this.previous_content=null;this.waiting=this.next_engine=!1};d.RenderContext.prototype=f.extend({},d.Object.prototype,{then:function(a){if(!h(a))if("string"===typeof a&&a in this.event_context)var b=this.event_context[a],a=function(a){return b.apply(this.event_context,[a])};else return this;var c=this;this.waiting?this.callbacks.push(a):(this.wait(),g.setTimeout(function(){var b=a.apply(c,[c.content,c.previous_content]);!1!==b&&c.next(b)},0));return this},wait:function(){this.waiting=
!0},next:function(a){this.waiting=!1;"undefined"!==typeof a&&(this.previous_content=this.content,this.content=a);0<this.callbacks.length&&this.then(this.callbacks.shift())},load:function(a,b,c){var e=this;return this.then(function(){var d,j,i;h(b)?(c=b,b={}):b=f.extend({},b);c&&this.then(c);if("string"===typeof a){d=(i=a.match(/\.json$/)||b.json)&&!0===b.cache||!1!==b.cache;e.next_engine=e.event_context.engineFor(a);delete b.cache;delete b.json;b.engine&&(e.next_engine=b.engine,delete b.engine);if(d&&
(j=this.event_context.app.templateCache(a)))return j;this.wait();f.ajax(f.extend({url:a,data:{},dataType:i?"json":"text",type:"get",success:function(b){d&&e.event_context.app.templateCache(a,b);e.next(b)}},b));return!1}if(a.nodeType)return a.innerHTML;if(a.selector)return e.next_engine=a.attr("data-engine"),!1===b.clone?a.remove()[0].innerHTML.toString():a[0].innerHTML.toString()})},loadPartials:function(a){var b;if(a)for(b in this.partials=this.partials||{},a)(function(b,e){b.load(a[e]).then(function(a){this.partials[e]=
a})})(this,b);return this},render:function(a,b,c,e){return h(a)&&!b?this.then(a):this.loadPartials(e).load(a).interpolate(b,a).then(c)},partial:function(a,b,c){return h(c)?this.render(a,b).swap(c):!c&&h(b)?this.render(a).swap(b):this.render(a,b).swap()},send:function(){var a=this,b=k(arguments),c=b.shift();l(b[0])&&(b=b[0]);return this.then(function(){b.push(function(b){a.next(b)});a.wait();c.apply(c,b);return!1})},collect:function(a,b,c){var e=this,d=function(){h(a)&&(b=a,a=this.content);var c=[],
d=!1;f.each(a,function(a,f){var g=b.apply(e,[a,f]);if(g.jquery&&g.length==1){g=g[0];d=true}c.push(g);return g});return d?c:c.join("")};return c?d():this.then(d)},renderEach:function(a,b,c,d){l(b)&&(d=c,c=b,b=null);return this.load(a).then(function(g){var h=this;c||(c=l(this.previous_content)?this.previous_content:[]);if(d)f.each(c,function(c,f){var k={},l=this.next_engine||a;b?k[b]=f:k=f;d(f,h.event_context.interpolate(g,k,l))});else return this.collect(c,function(c,d){var e={},f=this.next_engine||
a;b?e[b]=d:e=d;return this.event_context.interpolate(g,e,f)},true)})},interpolate:function(a,b,c){var d=this;return this.then(function(f,g){!a&&g&&(a=g);this.next_engine&&(b=this.next_engine,this.next_engine=!1);var h=d.event_context.interpolate(f,a,b,this.partials);return c?g+h:h})},swap:function(a){return this.then(function(b){this.event_context.swap(b,a);return b}).trigger("changed",{})},appendTo:function(a){return this.then(function(b){f(a).append(b)}).trigger("changed",{})},prependTo:function(a){return this.then(function(b){f(a).prepend(b)}).trigger("changed",
{})},replace:function(a){return this.then(function(b){f(a).html(b)}).trigger("changed",{})},trigger:function(a,b){return this.then(function(c){"undefined"==typeof b&&(b={content:c});this.event_context.trigger(a,b);return c})}});d.EventContext=function(a,b,c,e,f){this.app=a;this.verb=b;this.path=c;this.params=new d.Object(e);this.target=f};d.EventContext.prototype=f.extend({},d.Object.prototype,{$element:function(){return this.app.$element(k(arguments).shift())},engineFor:function(a){var b;if(h(a))return a;
a=(a||this.app.template_engine).toString();if(b=a.match(/\.([^\.\?\#]+)$/))a=b[1];return a&&h(this[a])?this[a]:this.app.template_engine?this.engineFor(this.app.template_engine):function(a){return a}},interpolate:function(a,b,c,d){return this.engineFor(c).apply(this,[a,b,d])},render:function(a,b,c,e){return(new d.RenderContext(this)).render(a,b,c,e)},renderEach:function(a,b,c,e){return(new d.RenderContext(this)).renderEach(a,b,c,e)},load:function(a,b,c){return(new d.RenderContext(this)).load(a,b,c)},
partial:function(a,b,c){return(new d.RenderContext(this)).partial(a,b,c)},send:function(){var a=new d.RenderContext(this);return a.send.apply(a,arguments)},redirect:function(){var a;a=k(arguments);var b=this.app.getLocation(),c=a.length;if(1<c){for(var d=0,g=[],h=[],i={},l=!1;d<c;d++)"string"==typeof a[d]?g.push(a[d]):(f.extend(i,a[d]),l=!0);a=g.join("/");if(l){for(var m in i)h.push(this.app._encodeFormPair(m,i[m]));a+="?"+h.join("&")}}else a=a[0];this.trigger("redirect",{to:a});this.app.last_location=
[this.verb,this.path];this.app.setLocation(a);RegExp(a).test(b)&&this.app.trigger("location-changed")},trigger:function(a,b){"undefined"==typeof b&&(b={});b.context||(b.context=this);return this.app.trigger(a,b)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(a,b){return this.app.swap(a,b)},notFound:function(){return this.app.notFound(this.verb,this.path)},json:function(a){return f.parseJSON(a)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});
f.sammy=g.Sammy=d})(jQuery,window);