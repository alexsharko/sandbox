(function(a){a.fn.ajaxoverlay=function(e){var b={overlay:true,background:"#000",showclosebutton:true,recursiveselector:false,width:"450",height:"",extraclass:"",opacity:.7,columnwidth:"",closebuttonselector:"",source:"",dobeforeopen:function(){},doafteropen:function(){},dobeforeclose:function(){},doafterclose:function(){},form:{selector:"",trigger:"",url:"",customField:""},debugmode:false},d,c={debug:function(a){b.debugmode&&console.log(a)},init:function(h){var g=this;c.debug("initialising overlay");if(!b.source&&!b.form.selector){var f=a(h).attr("href");c.spawnOverlay();a.ajax({type:"get",url:f,success:function(a){c.spawnPopup(a,c.bindEvents)},error:function(){c.removeEverything(false)}})}else if(b.source){c.spawnOverlay();c.spawnPopup(a(b.source),c.bindEvents)}else if(b.form.selector){var d=a(b.form.selector),e=d.attr("action");if(b.form.url)e=b.form.url;if(b.form.trigger)a(b.form.trigger).live("click",function(){c.interceptFormViaAjax(d,e)});else d.live("submit",function(){c.interceptFormViaAjax(d,e)})}return g.preventDefault()},interceptFormViaAjax:function(e,f){c.debug("submitting form via ajax");var d=e.serialize();if(b.form.customField)d+="&"+b.form.customField+"=1";a.ajax({url:f,data:d,type:e.attr("method"),success:function(d){var b=a("#ajaxoverlay-formresponse-temp");b.remove();b=a('<div id="ajaxoverlay-formresponse-temp">'+d+"</div>").appendTo("body");c.spawnOverlay();c.spawnPopup(b,c.bindEvents)},error:function(){c.removeEverything(false)}});return false},spawnOverlay:function(){c.removeEverything(true);if(b.overlay){c.debug("creating background overlay");if(b.extraclass!=="")b.extraclass=" "+b.extraclass;var d=a(document).height(),e=a('<div class="ajax-overlay-bg'+b.extraclass+'"></div>');e.prependTo("body").css({background:b.background,height:d+"px"}).fadeTo(0,b.opacity)}},spawnPopup:function(i,h){c.debug("adding popup and positioning it onscreen");var g=a("body").children().first();if(b.overlay)g="div.ajax-overlay-bg";var e=a('<div class="ajax-popup-window'+b.extraclass+" "+b.columnwidth+'"></div>'),f={width:b.width+"px"};if(b.columnwidth)f.width="";if(b.height)f.height=b.height+"px";e.insertBefore(g).css(f).hide();var l=a(i);l.appendTo(e);e.show();b.dobeforeopen&&b.dobeforeopen.call(d);b.source&&a(b.source).show();var k=(a(window).height()-e.outerHeight())/2+a(window).scrollTop()+"px",j=(a(window).width()-e.outerWidth())/2+a(window).scrollLeft()+"px";e.css({top:k,left:j}).show();b.showclosebutton&&e.prepend('<div class="ajax-close-button"><a href="#">x</a></div>');e.attr("tabindex","-1").focus();typeof h==="function"&&h.call(this)},bindEvents:function(){c.debug("binding click events for close buttons etc");b.recursiveselector&&a("div.ajax-popup-window "+b.recursiveselector).ajaxoverlay(e);a("div.ajax-close-button a").live("click",function(a){c.removeEverything(true);return a.preventDefault()});b.overlay&&a("div.ajax-overlay-bg").live("click",function(a){c.removeEverything(true);return a.preventDefault()});b.closebuttonselector&&a(b.closebuttonselector).live("click",function(a){c.removeEverything(true);return a.preventDefault()});a(document).keydown(function(a){a.keyCode===27&&c.removeEverything(true)});b.doafteropen&&b.doafteropen.call(d)},removeEverything:function(e){c.debug("removing overlay elements from page and unbinding events");b.dobeforeclose&&e&&b.dobeforeclose.call(d);var f=a(".ajax-popup-window").children();f.length!==0&&a(f.get(1)).appendTo("body").hide();a(".ajax-popup-window, .ajax-overlay-bg").remove();b.doafterclose&&e&&b.doafterclose.call(d);a("div.ajax-close-button a").die("click");b.overlay&&a("div.ajax-overlay-bg").die("click");b.closebuttonselector&&a(b.closebuttonselector).die("click");a(document).unbind("keydown");if(b.form.selector)if(b.form.trigger)a(b.form.trigger).die("click");else{var g=a(b.form.selector);g.die("submit")}return false}};return this.each(function(){e&&a.extend(b,e);var f=a(this);f.mousedown(function(a){c.debug("user has clicked on element");d=f;return c.init.call(a,d)})})}})(jQuery)